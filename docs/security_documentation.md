# エンタープライズレベルセキュリティ機能ドキュメント

## 概要

本ドキュメントでは、システムに実装されているエンタープライズレベルのセキュリティ機能について詳細に説明します。これらの機能は、データ保護、ユーザー認証、アクセス制御、監査ログ、コンプライアンス対応などの多岐にわたるセキュリティ要件を満たすために設計されています。

## 主要コンポーネント

システムのセキュリティは以下の主要コンポーネントによって構成されています：

1. **認証マネージャー** (`AuthManager`)
2. **コンプライアンスマネージャー** (`ComplianceManager`)
3. **レート制限機能** (`RateLimiter`)
4. **認証メトリクス** (`AuthMetrics`)

## 1. 多要素認証 (MFA)

### サポートされるMFA方式

- **TOTP（時間ベースワンタイムパスワード）**
  - Google AuthenticatorやAuthy等の標準的なTOTPアプリと互換性あり
  - QRコードを使用した簡単なセットアップ
  - RFC 6238準拠

- **SMS認証**
  - 電話番号検証
  - ショートメッセージによるコード送信

- **Eメール認証**
  - 登録済みメールアドレスへのコード送信
  - 有効期限付きの使い捨てコード

### MFA設定と検証フロー

1. ユーザーがMFA設定を開始
2. システムが認証シークレットを生成
3. QRコードまたは直接設定方法をユーザーに提示
4. ユーザーが認証アプリで初期コードを生成
5. システムがコードを検証し、MFAを有効化

## 2. パスワード管理とポリシー

### パスワードハッシュ

- **Argon2ハッシュ使用**
  - 2015年Password Hashing Competitionの勝者
  - メモリハード関数による強力な保護
  - 設定パラメータ：
    - `time_cost`: 3
    - `memory_cost`: 65536
    - `parallelism`: 4

### パスワードポリシー

- 最小長：8文字以上
- 複雑性要件：
  - 大文字を含む
  - 小文字を含む
  - 数字を含む
  - 特殊文字を含む
- パスワードの有効期限設定（デフォルト：90日）
- パスワード再利用防止（直近5つのパスワードの再利用禁止）
- 自動的なパスワード強度チェック

## 3. セッション管理

### セッションポリシー

- ユーザーあたりの最大セッション数制限（デフォルト：5）
- セッションタイムアウト（デフォルト：60分）
- アイドルタイムアウト（デフォルト：15分）
- オプションのIPアドレスバインディング
- オプションのデバイスバインディング

### トークン管理

- JWT（JSON Web Token）ベースの認証
- 短期間の有効期限（デフォルト：30分）
- リフレッシュトークンの仕組み
- MFA検証用の特殊トークン（5分間有効）
- トークン無効化（ログアウト時）

## 4. レート制限

### レート制限設定

- エンドポイント別の制限：
  - ログイン：1分間に5回まで
  - 登録：5分間に3回まで
  - パスワードリセット：1時間に3回まで
  - MFA検証：5分間に5回まで
  - その他のエンドポイント：1分間に60回まで

### 実装詳細

- Redis（利用可能な場合）またはメモリ内キャッシュを使用
- クライアントIPアドレスとエンドポイントに基づく制限
- ヘルスチェックとメトリクスエンドポイントの除外
- カスタマイズ可能なホワイトリスト

## 5. 監査とコンプライアンス

### イベントログ

以下のイベントタイプが記録されます：

- ログイン（成功/失敗）
- ログアウト
- ユーザー登録
- パスワード変更/リセット
- プロファイル更新
- ロール変更
- MFA有効化/無効化
- トークン更新
- 管理者アクション
- 不審なアクティビティ
- レート制限超過
- ポリシー違反
- データアクセス

### イベント情報

各イベントには以下の情報が含まれます：

- タイムスタンプ
- イベントタイプ
- ユーザーID
- IPアドレス
- ユーザーエージェント
- アクション詳細
- 成功/失敗フラグ

### データ保持ポリシー

- 監査ログの保持期間設定（デフォルト：365日）
- ユーザーデータの保持期間設定（デフォルト：730日）
- 非アクティブアカウントの自動検出と処理（デフォルト：730日後）

## 6. GDPR対応

### データ主体の権利サポート

- データアクセス権（データエクスポート）
- 忘れられる権利（データ削除）
- 処理の制限
- データポータビリティ

### 実装詳細

- ユーザーデータのエクスポート機能
  - 個人情報
  - アクティビティログ
  - 関連データ

- データ削除機能
  - 個人情報の完全削除
  - または匿名化処理
  - 関連データの削除

## 7. アクセス制御

### ロールベースのアクセス制御

- **管理者ロール**：すべての機能にアクセス可能
- **ユーザーロール**：基本的な機能のみアクセス可能
- **アナリストロール**：特定の分析機能にアクセス可能
- **VCロール**：投資家向け機能にアクセス可能

### APIセキュリティ

- スコープベースの認証
- エンドポイントごとの権限確認
- 適切なHTTPステータスコード（401, 403など）

## 8. メトリクスと監視

### 収集される主要メトリクス

- ログイン試行回数（成功/失敗）
- アクティブユーザー数
- アクティブセッション数
- レート制限ヒット数
- 不審なアクティビティ数

### アラート機能

- 複数の失敗したログイン試行
- レート制限超過パターン
- 不審なアクティビティ検出
- ポリシー違反

## 9. セキュリティのベストプラクティス

### 実装済みのベストプラクティス

- 徹底したエラーハンドリング
- センシティブデータの適切なログ除外
- HTTPSの強制（本番環境）
- セキュリティヘッダーの適切な設定
- クロスサイトスクリプティング（XSS）対策
- クロスサイトリクエストフォージェリ（CSRF）対策

## 10. 設定と拡張

### 設定可能なセキュリティパラメータ

- レート制限閾値とウィンドウサイズ
- パスワードポリシーの各要素
- セッションパラメータ
- データ保持期間
- MFA設定

### セキュリティ拡張ポイント

- カスタムパスワードバリデータの追加
- 追加の認証プロバイダー統合
- セキュリティ監視の強化
- コンプライアンスレポートのカスタマイズ

---

**注記**: このドキュメントは継続的に更新され、システムのセキュリティ機能の強化に伴って拡張されます。