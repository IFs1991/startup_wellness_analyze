# API テストカバレッジ計画

## 概要

このドキュメントでは、APIリファクタリングプロジェクト前に確保すべきテストカバレッジについて計画を詳述します。
リファクタリング中の機能退行を防止するため、重要なパスを特定し、優先的にテストします。

## テスト種別とアプローチ

### 1. 単体テスト
- **目的**: 個々の関数、メソッド、クラスの正確性を検証
- **フレームワーク**: pytest
- **カバレッジ目標**: コア機能の90%以上、全体で80%以上

### 2. 統合テスト
- **目的**: コンポーネント間の相互作用を検証
- **フレームワーク**: pytest（FastAPIのTestClientを使用）
- **カバレッジ目標**: すべての重要なAPI統合フローの100%

### 3. エンドツーエンドテスト
- **目的**: 完全なユーザーフローを検証
- **フレームワーク**: pytest + Playwright/Selenium（UIテスト向け）
- **カバレッジ目標**: すべての主要ユーザーフローの100%

## 重要テスト対象

### 1. 可視化関連エンドポイント（優先度: 高）

routes/visualization.py および routers/gemini_visualization.py の主要機能:

| エンドポイント | テスト種別 | テスト内容 | 優先度 |
|--------------|---------|---------|--------|
| `/api/v1/visualizations/chart` | 単体 + 統合 | チャート生成機能（正常パラメータ） | 高 |
| `/api/v1/visualizations/chart` | 単体 + 統合 | チャート生成機能（異常パラメータ） | 高 |
| `/api/v1/visualizations/multiple-charts` | 単体 + 統合 | 複数チャート生成機能 | 中 |
| `/api/v1/visualizations/dashboard` | 単体 + 統合 | ダッシュボード生成機能 | 高 |
| `/api/v1/visualizations/chart/background` | 統合 | バックグラウンド処理機能 | 中 |
| `/api/v1/visualizations/chart/status/{cache_key}` | 統合 | キャッシュ取得機能 | 中 |
| `/visualization/gemini/*` | 統合 | 対応するroutersエンドポイント | 高 |

### 2. レポート関連エンドポイント（優先度: 高）

routes/reports.py および routers/reports.py の主要機能:

| エンドポイント | テスト種別 | テスト内容 | 優先度 |
|--------------|---------|---------|--------|
| `/api/v1/reports/generate` | 単体 + 統合 | レポート生成機能（同期） | 高 |
| `/api/v1/reports/generate-async` | 統合 | 非同期レポート生成機能 | 高 |
| `/api/v1/reports/download/{filename}` | 統合 | レポートダウンロード機能 | 中 |
| `/api/v1/reports/templates` | 単体 + 統合 | テンプレート一覧取得機能 | 中 |
| `/api/reports/*` | 統合 | 対応するroutersエンドポイント | 高 |

### 3. 共通コンポーネント（優先度: 高）

| コンポーネント | テスト種別 | テスト内容 | 優先度 |
|--------------|---------|---------|--------|
| `GeminiChartGenerator` | 単体 | チャート生成機能 | 高 |
| `GeminiWrapper` | 単体 | Gemini API呼び出し | 高 |
| `ReportGenerator` | 単体 | レポート生成ロジック | 高 |
| エラー処理ミドルウェア | 統合 | 各種エラー状況のハンドリング | 高 |
| 認証・認可機能 | 統合 | 権限チェック機能 | 高 |

## 特殊なテスト考慮事項

### 1. 外部依存のモック

以下の外部依存はテスト時にモック化します:
- Gemini API
- データベース接続
- 外部ファイルシステム操作

### 2. 非同期処理のテスト

- バックグラウンドタスクはタスクキューをモック化
- `asyncio.sleep`などの遅延は最小化またはモック化

### 3. キャッシュ機能のテスト

- キャッシュヒット・ミスの両方をテスト
- キャッシュの有効期限切れシナリオのテスト

## テストデータ戦略

1. **テストフィクスチャー**:
   - 標準的なテストデータをpytestフィクスチャーとして定義
   - JSON形式でテストデータを保存

2. **テストケースカバレッジ**:
   - 正常系: すべての有効な入力パターン
   - 異常系: 境界値、無効な入力、存在しないリソース
   - エッジケース: 極端な入力値、並行処理

## テスト実装計画

### フェーズ1: テスト基盤整備

- プロジェクトにpytest設定を追加
- モックおよびフィクスチャーフレームワークの構築
- CIパイプラインへのテスト統合

### フェーズ2: 単体テスト実装

1. 可視化機能の単体テスト
2. レポート機能の単体テスト
3. 共通コンポーネントの単体テスト

### フェーズ3: 統合テスト実装

1. APIエンドポイントの統合テスト
2. エラー処理の統合テスト
3. 認証・認可の統合テスト

### フェーズ4: エンドツーエンドテスト実装

1. 主要ユーザーフローのE2Eテスト
2. エッジケースのE2Eテスト

## テスト自動化

1. **CI/CD統合**:
   - GitHub Actionsでの自動テスト実行
   - プルリクエスト時の自動テスト実行
   - 定期的な夜間テスト実行

2. **テスト報告**:
   - カバレッジレポート生成
   - テスト失敗の自動通知

## カバレッジ測定

- **ツール**: pytest-cov
- **メトリクス**:
  - 行カバレッジ
  - 分岐カバレッジ
  - 関数カバレッジ

## テスト成功基準

リファクタリング前に以下の基準を満たす必要があります:

1. すべての重要パスで80%以上のコードカバレッジ
2. すべての主要APIエンドポイントの統合テスト完了
3. ゼロの既知の未修正バグ
4. すべての主要ユーザーフローのE2Eテスト完了

## テスト維持計画

1. 新機能開発と並行したテスト開発
2. 四半期ごとのテストスイート見直し
3. 発見されたバグに対する回帰テストの自動追加