# データベース関連ファイル構成

このディレクトリには、PostgreSQLデータベースに関連するファイルが含まれています。

## ディレクトリ構造

```
backend/database/
├── migrations/           # データベースマイグレーションファイル
│   └── versions/         # バージョン管理されたマイグレーションスクリプト
├── schemas/              # テーブル定義などのスキーマファイル
├── seed/                 # 初期データ投入用SQLファイル
│   ├── master/           # マスターデータ
│   └── weights/          # 分析用重みデータなど
├── models/               # データモデル定義
├── repositories/         # データアクセスリポジトリ
└── tests/                # データベース関連テスト
```

## 各ディレクトリの目的

### migrations/

データベーススキーマの変更履歴を管理するためのディレクトリです。Alembicを使用してマイグレーションを管理します。

- **versions/** - 各マイグレーションバージョンのスクリプトを格納します。

### schemas/

テーブル定義やビュー、ストアドプロシージャなどのスキーマ定義を含むSQLファイルを格納します。
1つのファイルには関連する一連のテーブル定義を含めます。

### seed/

データベース初期化時に投入する初期データのSQLファイルを格納します。

- **master/** - 基本的なマスターデータを含むSQLファイル
- **weights/** - 分析用重みデータなど、計算に使用される係数データを含むSQLファイル

### models/

SQLAlchemyを使用したORMモデル定義を格納します。

### repositories/

データアクセスロジックを含むリポジトリクラスを格納します。

## ファイル配置ルール

1. スキーマ定義とデータは明確に分離する
   - テーブル作成などのDDLは `schemas/` ディレクトリに配置
   - データ挿入などのDMLは `seed/` ディレクトリに配置

2. ファイル命名規則
   - スキーマファイル: `<機能名>.sql`
   - シードデータファイル: `<機能名>.sql`

3. ファイルヘッダー
   すべてのSQLファイルには以下の情報を含むヘッダーコメントを記載する:
   - ファイルの目的
   - 作成日
   - 変更履歴

## マイグレーション管理の方針

1. スキーマの変更はすべてマイグレーションファイルとして記録する
2. マイグレーションは自動テストで検証してから適用する
3. 本番環境への適用前にステージング環境でテストする
4. ダウングレードスクリプトも必ず用意する
5. データ量の多いテーブルの変更は、パフォーマンス影響を考慮する

## 初期化プロセス

アプリケーション起動時の初期化プロセスは以下の手順で行われます:

1. マイグレーションの実行（未適用のマイグレーションがある場合）
2. マスターデータの挿入（必要に応じて）
3. 分析用重みデータの挿入（必要に応じて）

## 使用例

### 新しいスキーマの追加

```sql
-- backend/database/schemas/example.sql
-- 例示用テーブル定義
-- 作成日: 2025-05-15

CREATE TABLE example (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 新しいシードデータの追加

```sql
-- backend/database/seed/master/example.sql
-- 例示用初期データ
-- 作成日: 2025-05-15

INSERT INTO example (name) VALUES
('サンプル1'),
('サンプル2'),
('サンプル3');
```