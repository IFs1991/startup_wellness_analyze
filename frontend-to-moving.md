スタートアップウェルネス分析システム フロントエンド移行計画
1. 目的と背景
既存の @src フロントエンドから新しい @new-frontend-idea プロジェクトへの移行を行い、よりユーザーフレンドリーなUI/UXを実現する。新デザインではチャットモードを前面に出し、分析モードへの切り替えを可能にすることで、データサイエンスの専門知識がないユーザーでも使いやすいインターフェースを提供する。
2. 技術スタックの比較
| | 既存 (@src) | 新デザイン (@new-frontend-idea) |
|---------|---------|---------|
| フレームワーク | Vite + React | Next.js (App Router) |
| スタイリング | CSS-in-JS (推測) | Tailwind CSS |
| UIコンポーネント | MUI系? | shadcn/ui |
| 状態管理 | Context API + カスタムフック | Context API + カスタムフック |
| APIクライアント | カスタム実装 | 再利用 + Next.js API対応 |
| 認証 | Firebase Auth | Firebase Auth (再利用) |
| 決済 | Stripe | Stripe (再利用) |
3. 再利用可能なモジュールの特定
3.1 高優先度項目（最小限の修正で再利用可能）
hooks/: バックエンドAPI通信と状態管理のコア
useWebSocketConnection.ts
useSubscription.ts - サブスクリプション管理ロジック
useCompliance.ts
useDataQuality.ts
useSettings.ts
useReportGenerator.ts
useTextMining.ts
useWellnessAnalysis.ts
useCompanyData.ts
useAuth.ts
useAnalysis.ts
firebase/: Firebase設定
config.ts
types/: 型定義
company.ts など
lib/utils.ts: ユーティリティ関数
3.2 中優先度項目（修正を要する再利用）
api/: バックエンドAPI通信
apiClient.ts
types.ts
services/ ディレクトリ
contexts/: グローバル状態管理
AuthContext.tsx（認証部分）
lib/ai-insights-generator.ts: AI機能実装
components/subscription/: サブスクリプション関連の設計と実装知識
components/analysis/: 複雑な分析機能の実装（ロジック部分は高価値）
3.3 低優先度項目（参考にしつつ再実装）
components/: その他のUIコンポーネント
ロジック部分は再利用、UI実装はTailwind化
theme.ts: テーマ設定
Tailwind設定に変換

3.4 サブスクリプション機能の移行
既存システムでは、以下のサブスクリプション関連機能が実装されています：

- **二段階トライアルアプローチ**:
  - 7日間の機能制限付き無料トライアル（クレジットカード不要）
  - 14日間のフル機能トライアル（クレジットカード必須、Stripe連携）

- **コアコンポーネント**:
  - `TrialSelectionModal.tsx`: トライアル選択UI
  - `useSubscription.ts`: サブスクリプション管理ロジック
  - Stripe APIとの連携処理

移行に際しては、以下の点に注意が必要です：
- MUIベースのUIコンポーネントをshadcn/ui + Tailwindに置き換える
- 認証フローとの連携処理の維持
- バックエンドAPIとの整合性確保

3.5 分析コンポーネントの移行
`components/analysis/` ディレクトリには、アプリケーションのコア機能となる高度な分析コンポーネントが含まれています：

**主要な分析コンポーネント**:
- `CorrelationAnalysis.tsx`: 変数間の相関関係分析
- `TimeSeriesAnalysis.tsx`: 時系列データの傾向分析
- `ClusterAnalysis.tsx`: 類似企業のグループ化と特性分析
- `BayesianAnalysis.tsx`: ベイズ推論による確率的分析
- `TextMiningAnalysis.tsx`: テキストデータの解析
- `PredictiveModelAnalysis.tsx`: 将来予測モデル
- `StartupSurvivabilityAnalysis.tsx`: スタートアップ生存率分析
- `VCROIAnalysis.tsx`: ベンチャーキャピタルのROI分析
- `MonteCarloSimulation.tsx`: モンテカルロシミュレーション
- `CausalInferenceAnalysis.tsx`: 因果推論分析

**移行アプローチ**:
1. **分析ロジックとUIの分離**:
   - 各分析コンポーネントからデータ処理・計算ロジックを抽出
   - ビジネスロジックをカスタムフックとして再実装
   - UIをTailwindとshadcn/uiでリデザイン

2. **データ可視化の再実装**:
   - 既存のグラフ・チャートライブラリの互換性確認
   - 必要に応じて代替ライブラリへの移行

3. **チャットインターフェースとの連携**:
   - 分析結果を会話形式で表示する機能
   - チャットから分析実行の導線確保

4. **優先順位づけ**:
   - 基本分析機能（相関、時系列、クラスタリング）を最初に実装
   - 高度な分析機能（ベイズ推論、因果推論など）を後続で実装

3.6 その他のコンポーネントとファイルの再利用評価

#### 高い再利用価値（ロジック抽出・UI調整で再利用）

1. **`components/charts/`**:
   - **内容**: `TimeSeriesChart`, `ClusterChart`, `CorrelationMatrix`, `BayesianChart` など20種類以上の専門的グラフコンポーネント
   - **価値**: データ可視化はアプリケーションの中核機能であり、グラフ描画ロジック、データ変換、座標計算などは高い価値がある
   - **移行方針**:
     - グラフ描画と計算ロジックを抽出
     - UIライブラリ依存部分をTailwindとshadcn/uiに置き換え
     - グラフライブラリ自体（recharts, visx, d3など）の互換性確認

2. **`components/ReportGenerator.tsx`**:
   - **内容**: レポート生成機能（テンプレート選択、セクション設定、生成処理）
   - **価値**: レポート設定や生成ロジックは再利用価値が高い
   - **移行方針**:
     - AntDesignからshadcn/uiへのUI置き換え
     - 生成ロジックとステート管理の分離

3. **`data/analysis-explanations.ts`**:
   - **内容**: 分析手法の説明データ
   - **価値**: チャットモードでの解説にも有用
   - **移行方針**: ほぼそのまま再利用 **[完了]** -> `new-frontend-idea/lib/` にコピー済み

4. **`services/api.ts`**:
   - **内容**: バックエンドAPI連携
   - **価値**: API通信の中核ロジック
   - **移行方針**: Next.jsのAPI通信方式に合わせた調整 **[完了]** -> `src/api/` を `new-frontend-idea/api/` にコピー済み。Next.js (Server/Client Components, Route Handlers) での動作確認と調整が必須。

#### 中程度の再利用価値（参考にしつつ再構築）

1. **`components/companies/`**:
   - **内容**: 企業リスト、詳細表示、フィルタリング、編集機能など
   - **価値**: 企業データ操作のビジネスロジック
   - **移行方針**: ロジック部分を抽出し、UIを再構築

2. **`components/dashboard/`**:
   - **内容**: ダッシュボードカード、メトリクス表示、ウェルネススコアチャートなど
   - **価値**: データ表示と集計ロジック
   - **移行方針**: レイアウトとロジックを参考に、新UIで再実装

3. **`components/settings/`**:
   - **内容**: 各種設定画面（ユーザー管理、セキュリティ設定など）
   - **価値**: 設定項目の構造と編集ロジック
   - **移行方針**: 設定構造を維持しつつUIを更新

4. **`pages/`**:
   - **内容**: 各種ページコンポーネント（ダッシュボード、分析、レポートなど）
   - **価値**: ページ構成とデータフロー
   - **移行方針**: Next.jsのApp Router構造に合わせた再構築

5. **`lib/ai-insights-generator.ts`**:
    - **内容**: AI機能実装
    - **価値**: AI関連のコアロジック
    - **移行方針**: `new-frontend-idea/lib/` にコピー済み **[完了]**。依存関係の解決とNext.js環境での動作確認が必要。

#### 低い再利用価値（置き換え推奨）

1. **`routes.tsx`と`routes/index.tsx`**:
   - **内容**: React Routerのルーティング設定
   - **価値**: 参考程度
   - **移行方針**: Next.jsのファイルベースルーティングに置き換え

2. **`App.tsx`と`main.tsx`**:
   - **内容**: アプリのエントリーポイントとレイアウトラッパー
   - **価値**: 構造参照のみ
   - **移行方針**: Next.jsのApp Router構造（`layout.tsx`など）に置き換え

3. **`store/index.ts`**:
   - **内容**: Reduxストア設定
   - **価値**: 状態管理アプローチの参考
   - **移行方針**: React Query + Context + フックベースの状態管理に刷新

4. 移行フェーズ
フェーズ1: 基盤構築と基本機能の移行 **[完了]**
- プロジェクト構造の確認・整備
  - Next.js App Routerの構造を理解・活用
  - TypeScript設定の継承と調整
- コアロジックの移行 **[完了]**
  - hooks/ ディレクトリのカスタムフック **[完了]**
    - `new-frontend-idea/hooks/` にコピー済み
    - Client Componentでの使用宣言 (`"use client"`) や依存関係を見直し・追加完了
    - `useAuth`、`useWebSocketConnection`、`useSubscription` を Next.js 環境に合わせて調整済み
    - ブラウザ環境のチェック（`typeof window !== 'undefined'`）を追加
  - firebase/ 認証関連 **[完了]**
    - `new-frontend-idea/firebase/` にコピー済み
    - 初期化処理などを Next.js に合わせて修正済み
    - `"use client"` ディレクティブ追加
    - 環境変数を `process.env.NEXT_PUBLIC_*` 形式に変更
  - api/ クライアント（Next.js向けに調整） **[完了]**
    - `new-frontend-idea/api/` にコピー済み
    - Client Component 指定
    - `window` オブジェクトのチェック追加
    - 環境変数を Next.js 形式に変更済み
  - types/ 型定義 **[完了]** -> `new-frontend-idea/types/` にコピー済み
  - lib/utils.ts **[完了]** -> `new-frontend-idea/lib/` にコピー済み
  - lib/ai-insights-generator.ts **[完了]** -> `new-frontend-idea/lib/` にコピー済み
  - data/analysis-explanations.ts **[完了]** -> `new-frontend-idea/lib/` にコピー済み
  - contexts/ **[完了]**
    - `AuthContext.tsx` を Next.js 環境用に新規作成・実装済み
    - 認証関連の機能（ログイン、登録、ログアウト、パスワードリセット、プロフィール更新）を実装
      - [x] ログインページ (`app/login/page.tsx`) の実装
    - `AuthProvider` をApp Routerのルートレイアウト（`layout.tsx`）に統合
- 依存関係の解決 **[完了]**
  - `firebase` と `axios` パッケージを追加
  - Firebase Authとの連携確認
  - APIクライアントの動作確認

フェーズ2: チャットモードの設計・実装 **[完了]**
チャットインターフェースの設計
- チャットビューのメインコンポーネント（`components/chat-view.tsx`）の作成
- チャットメッセージの型定義
- メッセージ入力・表示UIの実装
  - メッセージリストコンポーネントの作成
  - メッセージ入力フォーム実装
  - チャットバブルのUIデザイン（ユーザーメッセージとAIレスポンスの視覚的区別）
チャット履歴管理の状態設計
- メッセージ履歴の状態管理フックの作成
- ローカルストレージを利用した永続化
WebSocketによるリアルタイム通信実装
- useWebSocketConnection の再利用と拡張
- チャットメッセージ処理の追加
AIレスポンス生成機能の実装
- ai-insights-generator.ts の機能活用
- プロンプト設計と応答フォーマット定義
- 分析結果の可視化表示機能
  - 分析結果カードコンポーネント（`analysis-result-card.tsx`）
  - チャットメッセージ内での分析結果表示
  - インサイト詳細とグロッサリー用ツールチップ
- チャット履歴の永続化
  - ローカルストレージを使用した永続化
  - ユーザーごとのチャット履歴管理
  - 履歴の読み込み・保存・削除機能
- [x] 添付ファイル機能の実装
  - [x] ファイル添付UI開発（`file-attachment.tsx`）
  - [x] ファイルアップロード処理（`/api/chat/with-attachments`）
  - [x] 添付ファイル表示用コンポーネント
  - [x] ファイル取得用エンドポイント実装（`/api/attachments/[userId]/[filename]`）
  - [x] チャットメッセージへの添付ファイル統合
  - [x] ファイルのプレビュー表示機能（画像/一般ファイル）
- [x] マークダウン/リッチテキストサポート
  - [x] react-markdownライブラリの導入
  - [x] rehype-rawとremark-gfmプラグインの追加
  - [x] マークダウンコンテンツのスタイル定義
  - [x] コードブロック、表、リスト、リンクなどの表示対応
  - [x] チャットメッセージ内での活用実装
- [x] チャットからの分析リクエスト連携機能
  - [x] 分析リクエストボタンコンポーネント（`analysis-request-button.tsx`）の実装
  - [x] 分析タイプとパラメータ選択UI
  - [x] 分析リクエストAPIエンドポイント（`/api/analysis/request`）の実装
  - [x] チャットインターフェースとの統合
  - [x] 分析結果の表示とインサイト共有
- [x] オフライン時のキャッシュと再送信機能
  - [x] `OfflineQueueService` クラスの実装（`lib/offline-queue.ts`）
  - [x] `useOfflineQueue` フックの作成（`lib/hooks/use-offline-queue.ts`）
  - [x] `useChatState` フックへのオフライン対応機能追加
  - [x] オフライン状態検出と視覚的フィードバック（UI）
  - [x] メッセージの自動キャッシュと復元機能
  - [x] ネットワーク回復時の自動再送信
  - [x] キャッシュされたメッセージ数の表示
  - [x] メッセージステータス（送信中、エラー、成功）の管理

### 将来のオプション機能：
- [ ] Firestoreを使用したクラウド永続化
- [ ] オフラインメッセージの優先順位付け
- [ ] 添付ファイルのチャンク分割アップロード

## 次のステップ
フェーズ2のチャット機能実装が完了しました。ユーザーはチャットインターフェースから直接分析をリクエストできるだけでなく、ネットワーク接続が不安定な環境でも、オフラインキャッシュと再送信機能により中断なく操作できるようになりました。

次はフェーズ2.5「サブスクリプションUIの実装」に移行します。ここでは二段階トライアルアプローチの実装、Stripe連携、サブスクリプション管理画面の設計、および決済関連のエラーハンドリングを強化します。

## フェーズ2.5: サブスクリプションUIの実装 **[進行予定]**
- [ ] トライアル選択モーダルの再実装
- [ ] 二段階トライアルフローの最適化
- [ ] サブスクリプション管理画面の設計と実装
- [ ] Stripe連携の実装
- [ ] 決済関連のエラーハンドリングの改善
- [ ] プラン比較UIの実装
- [ ] サブスクリプション状態管理の改善

フェーズ3: 分析モードと切り替え機能の実装
分析モードのUI実装
分析画面のベースコンポーネント設計
分析タイプ選択インターフェース
フィルター・パラメータ設定UI
各分析機能の実装
基本分析機能の実装（相関、クラスタリング、時系列）
チャートとグラフの視覚化コンポーネント
高度な分析機能の実装（ベイズ推論、因果推論、予測モデルなど）
分析結果の保存・共有機能
レポート生成機能の実装
ReportGenerator.tsxのロジック再利用
レポートテンプレート設計
PDF/HTML出力機能
モード切替機能の実装
view-switcher.tsx の最適化
状態の引き継ぎロジック
アニメーション遷移効果
コンテキスト保持機能
チャットからの分析リクエストハンドリング
分析結果のチャット内表示
分析からチャットへのフィードバック
自然言語による分析結果解説機能

フェーズ4: テストと最適化
ユニットテスト実装
各フックのテスト
コンポーネントのテスト
分析ロジックのテスト
統合テスト実装
ユーザーフロー全体のテスト
API通信のモック
分析機能の出力検証テスト
サブスクリプションフローのテスト
異なるプランでの機能制限テスト
トライアル期間の移行テスト
パフォーマンス最適化
バンドルサイズ分析
レンダリングパフォーマンス
データ処理の最適化
グラフ描画パフォーマンスの最適化
API通信最適化
5. UI/UX改善方針
5.1 チャットモードの前面化
アプリ起動時にチャットインターフェースをデフォルト表示
質問例や提案クエリをプロンプトとして表示
レスポンス内に分析機能へのリンク/アクションを埋め込み
5.2 スムーズな切り替え体験
チャットでの対話から自然に分析モードへ導線を提供
モード切替時の視覚的フィードバック
共通ヘッダーに常にモード切替コントロールを配置
5.3 コンテキスト維持
チャットでの対話内容を分析モードでのフィルタやパラメータに反映
分析モードでの操作内容をチャットの履歴・文脈に取り込む
5.4 サブスクリプション体験の改善
トライアル選択と登録フローの簡素化
プラン比較UIの視覚的な改善
アップセルポイントをチャットフローに自然に組み込む
プラン制限に達した際の親切なガイダンス
5.5 分析体験の向上
複雑な分析の簡略化と段階的な表示
初心者向けガイダンスとヘルプの充実
結果の解釈支援（AIによる解説）
データの視覚化オプションの拡充
5.6 データ可視化の改善
グラフとチャートの統一デザイン
インタラクティブな操作性向上
モバイル対応の改善
アクセシビリティ対応
6. リスクと対策
6.1 技術的リスク
| リスク | 対策 |
|---------|---------|
| Next.jsとViteのアーキテクチャの違いによるフック動作の相違 | Client Componentでの利用を明示、必要に応じてフックを調整 |
| WebSocket通信のスケーラビリティ | 接続管理の最適化、必要に応じてポーリングにフォールバック |
| バンドルサイズの肥大化 | コード分割、動的インポートの活用、未使用コードの削除 |
| Stripe連携の複雑さ | テスト環境での十分な検証、Stripe公式SDKの活用 |
| 複雑な分析ロジックの移行 | 段階的なロジック移行、ユニットテストの重視、同一出力の検証 |
| グラフライブラリの互換性問題 | 早期のプロトタイプ検証、必要に応じた代替ライブラリの選定 |

6.2 ユーザー体験リスク
| リスク | 対策 |
|---------|---------|
| チャットモードの学習コスト | チュートリアル、ガイド機能の実装 |
| 分析モードとの行き来による混乱 | 一貫したナビゲーションデザイン、現在のモードの明示 |
| AIレスポンスの精度不足 | プロンプト設計の最適化、フィードバックループの実装 |
| サブスクリプション選択の複雑さ | 直感的なUI、明確な価値提案、簡潔な説明文 |
| 複雑な分析の理解困難 | 自然言語による解説、段階的な詳細表示、視覚的ガイド |
| データ可視化の情報過多 | 段階的な詳細表示、ユーザーレベルに応じた表示調整 |

7. スケジュール
| フェーズ | 期間 | マイルストーン |
|---------|---------|---------|
| フェーズ1 | 3週間 | 基盤構築、認証機能、基本UI、データ可視化基盤 |
| フェーズ2 | 3週間 | チャットモード完成、AIレスポンス |
| フェーズ2.5 | 2週間 | サブスクリプション機能実装 |
| フェーズ3 | 4週間 | 分析モード完成、モード切替機能 |
| フェーズ4 | 2週間 | テスト、最適化、バグ修正 |

合計期間: 約14週間（約3.5ヶ月）
8. 成功指標
定量的指標:
ページロード時間 < 2秒
WebSocketメッセージレイテンシ < 200ms
First Contentful Paint < 1.5秒
モバイル対応度スコア > 85%
サブスクリプション転換率 > 10%（無料トライアルから有料プランへ）
分析機能の使用率 > 30%（チャットから分析への移行割合）
グラフ描画時間 < 500ms（複雑なデータセットでも）
定性的指標:
非データサイエンス系ユーザーのタスク完了率向上
ユーザーセッション時間の延長
チャットから分析への誘導成功率
ユーザーフィードバックでのUI/UX満足度向上
複雑な分析の理解度向上
データ可視化の直感性向上